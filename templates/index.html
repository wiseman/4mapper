<html>
<head>
<link href="static/main.css" rel="stylesheet" type="text/css" />
<style>
body { background:#333; padding:20px; }
#header { margin:0 auto 10px auto; width:90%; background:#ff9; border:1px solid #000; }
#header #nav { float:right; padding:3px 10px; }
#header h1 { padding:3px 10px 0px 10px; margin:0; }
#header p { padding:0px 10px 3px 10px; margin:0; }
#footer { margin:0 auto; width:90%; border:1px solid #000; border-top:none; }
#footer p a { color:#333; }
#footer p { padding:5px 10px; margin:4px 0; background:#999; margin:0; }
</style>

<title>Where have I been? &ndash; my last 250 foursquare checkins</title>

<script type="text/javascript" src="http://maps.google.com/maps?file=api&v=2.x&key=ABQIAAAAy-QtcaLYn_SCweZpooQCBxRalkY-nKN85LMYBy2cKIu_ytkA0RTaMuuhU75PoP1yumnRf2gO45qz4w"></script>
<script type="text/javascript" language="javascript" src="static/raphael-min.js"></script>
<script type="text/javascript" language="javascript" src="static/cartographer.min.0.2jjw.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.3.2/dojo/dojo.xd.js" djConfig="isDebug:false"> </script>
<script language="javascript">

var cartographer; 

{% if authorized %}
var authorized = true;
{% else %}
var authorized = false;
{% endif %}

dojo.addOnLoad(load);


function load() {
  if( GBrowserIsCompatible() ) {
    var map = new GMap2(document.getElementById("map"));
    map.setCenter(new GLatLng(18, 0), 2);
    map.addControl(new GLargeMapControl());
    map.addMapType(G_PHYSICAL_MAP);
    do_map();
  }
}

function map_checkins(checkins) {
    console.log('checkins', checkins);
    checkins = checkins[0].checkin
    data = [];
    n = 0;
    for (i = 0; i < checkins.length; i++) {
        if (typeof(checkins[i].venue) != "undefined" && checkins[i].venue.length > 0) {
            venue = checkins[i].venue[0];
            if (typeof(venue.geolat) != "undefined") {
                data[n] = {lat: venue.geolat, lng: venue.geolong, val: 1, label: venue.name};
                n += 1;
            }
        }
    }

  if( GBrowserIsCompatible() ) {
    var map = new GMap2(document.getElementById("map"));
    map.setCenter(new GLatLng(18, 0), 2);
    map.addControl(new GLargeMapControl());
    map.addMapType(G_PHYSICAL_MAP);

    cartographer = Cartographer(map, {colorize:"#000",
                                      colorizeAlpha:.5});
    cartographer.cluster(data, {
            gridSize: 35,
            gridColor: "#c00",
            enableGrid: false,
            color:"#fff",
            colorHover:"#fff",
            stroke:"#fff",
            popup:"reduce",
            popupLabel:"<b>Number of checkins</b><br>"
                } );
    map.setCenter(centroid(data), Math.max(map.getZoom(),2));
  }
}

function do_map() {
    dojo.xhrGet({
            url: '/4/history',
            handleAs: 'json',
            load: function(data, ioargs) {
                map_checkins(data);
            },
            error: function(error, args) {
                console.warn("Error!", error, args);
            },
            timeout: 14000,
    });
}


function centroid(data) {
  lat_sum = 0.0;
  lng_sum = 0.0;
  for (i = 0; i < data.length; i++) {
    lat_sum += data[i].lat;
    lng_sum += data[i].lng;
  }
  console.log('centroid:', lat_sum / data.length, lng_sum / data.length);
  return GLatLng(lat_sum / data.length, lng_sum / data.length);
}



</script>
</head>
<body onunload="GUnload()">
<div id="header">
<div id="nav">By <a href="http://twitter.com/lemonodor">John Wiseman</a></div>
<h1>Where have I been? &ndash; my last 250 foursquare checkins</h1>
<p><small><i>(Zoom in for greater detail.)</i></small></p>

{% if not authorized %}
<form action="/authorize" method="POST">
<input type="submit" value="Authorize">
</form>
{% endif %}

</div>
<div id="map" style="margin:0 auto; width:90%;height:80%;max-height:600px; border:1px solid #000;"></div>
<div id="footer">
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-137136-4");
pageTracker._trackPageview();
} catch(err) {}</script>

</body>
</html>
